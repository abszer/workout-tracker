<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <%- include('./partials/styling.ejs') %>
     <link rel="stylesheet" href="/css/analysis.css">
     <script type = "text/javascript" src = "https://d3js.org/d3.v4.min.js"></script>
     <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
     <title>Analysis</title>
</head>
<body>
     <header>
          <h1><a id="title" href="/">GitFit</a></h1>
          <img src="/images/list.png" id="hamburger" alt="hamburger">
          <div class="hamburger-menu">
               <div class="menu">
                    <div class="menu-links">
                         <a class="button" href="/attributions">Attributions</a>
                         <a class="button" href="https://github.com/abszer">github</a>
                         <a class="button" href="https://www.linkedin.com/in/robertwhite3120/">Linkedin</a>
                         <a class="button" href="https://www.robwhite.dev">website</a>
                    </div>
               </div>
               <div class="menu-right"></div>
          </div>
          <% if(currentUser) { %>
               <form id="log-out" action="/session?_method=DELETE" method="POST">
                    <input class="button" type="submit" value="Log out">
               </form>
          <%}%>
     </header>

     <div class="container">

          <!-- if user is signed in this is visible:  -->
          <% if(currentUser) { %>
               <h2 class="welcome-msg" id="<%= selection %>">Analysis</h2>
               <h5 id="sub-heading">Max Weight For Exercise by Day</h5>
               <div class="data-container">
                    <div class="data"></div>
               </div>
               
          <%}else{%>
               <h2>Ready to GitFit?</h2>
          <%}%>
     </div>


     <script src="/scripts/sideMenu.js"></script>
     <script>

          const convertToInt = (arr) => {
               for(let i = 0; i < arr.length; i++){
                    arr[i] = Number(arr[i])
               }
               return arr;
          }

          const selection = $('.welcome-msg').attr('id')
          const routineIndex = parseInt(selection.slice(0, selection.indexOf('-')))
          const dayIndex = parseInt(selection.slice(selection.indexOf('-') + 1, selection.length))

          let maxExerciseStats = {}
          let dates = []
     
          // get user routine data from database
          $.ajax( {
               url: '/userData'
          }).then((allData) => {
               // get all weight data for exercises in routine
               let currentRoutineData = allData[routineIndex].data
               console.log('all routine data', currentRoutineData)
               for(let i = 0; i < currentRoutineData.length; i++){
                    dates.push(currentRoutineData[i].date.slice(0, 15)) // push date of exercise to dates array

                    for(const exerciseKey in currentRoutineData[i]){
                         if(!(exerciseKey in maxExerciseStats) && exerciseKey !== 'date'){
                              maxExerciseStats[exerciseKey] = []
                         }
                         if(exerciseKey in maxExerciseStats){
                              if(exerciseKey !== 'date' && !exerciseKey.includes('cardio')){
                                   
                                   let weightDataArr = convertToInt(currentRoutineData[i][exerciseKey].weight[0])
                                   
                                   let maxWeightOfArr = Math.max(...weightDataArr)
                                   
                                   maxExerciseStats[exerciseKey].push(maxWeightOfArr)
                                   
                              }else if(exerciseKey.includes('cardio')){
                                   
                                   let repDataArr = convertToInt(currentRoutineData[i][exerciseKey].reps[0])
                                   let maxRepOfArr = Math.max(...repDataArr)
                                   maxExerciseStats[exerciseKey].push(maxRepOfArr)
                              }
                         }
                    }
               }

               console.log(maxExerciseStats)
               console.log(dates)

               //graph data
               let i = 0;
               for(const exerciseKey in maxExerciseStats){
                    let data = maxExerciseStats[exerciseKey].reverse();
                    const $newDiv = $('<div>').addClass(`data${i}`).addClass('data')
                    const $newTitle = $('<h4>').text(exerciseKey.slice(exerciseKey.indexOf('-') + 1), exerciseKey.length)
                    $('.data-container')
                         .append($newTitle)
                         .append($newDiv)
     

                    let width = window.innerWidth
                         scaleFactor = 1.2 * width / width, 
                         barHeight = 40;
                    
                    let graph = d3.select(`.data${i}`)
                         .append("svg")
                         .attr("width", width)
                         .attr("height", barHeight * data.length);
                    
                    let bar = graph.selectAll("g")
                         .data(data)
                         .enter()
                         .append("g")
                         .attr("transform", function(d, i) {
                              return "translate(0," + i * barHeight + ")";
                         });
                    bar.append("rect").attr("width", function(d) {
                         return d * scaleFactor;
                    })
                    
                    .attr("height", barHeight - 1);
                    
                    bar.append("text")
                         .attr("x", function(d) { return (d*scaleFactor); })
                         .attr("y", barHeight / 2)
                         .attr("dy", ".35em")
                         .text(function(d) { return d; });
                    i++;  
               }

               //show log of what was done for each routine
               const $dataContainer = $('.data-container')
               const $dataUl = $('<ul>')
               $dataContainer.append($dataUl)

               console.log("this is the data: ", currentRoutineData[dayIndex])
               const selectedRoutine = currentRoutineData[dayIndex]
               for(const exercise in selectedRoutine){
                    if(exercise !== 'date'){
                         const $newLi = $('<li>').text('Exercise: ' + exercise.slice(exercise.indexOf('-') + 1, exercise.length))
                         $dataUl.append($newLi)
                         
                         const $subUlOne = $('<ul>')
                         let repsString = '';
                         for(rep of selectedRoutine[exercise].reps){
                              
                              repsString += '' + rep + ','
                         }
                         repsString = repsString.slice(0, repsString.length - 1)
                         $subUlOne.append($('<li>').text('Rep Progression: ' + repsString));

                         const $subUlTwo = $('<ul>')
                         let weightString = '';
                         for(weight of selectedRoutine[exercise].weight){
                              
                              weightString += '' + weight + ','
                         }
                         weightString = weightString.slice(0, weightString.length - 1)
                         $subUlTwo.append($('<li>').text('Weight Progression: ' + weightString));

                         $dataUl.append($subUlOne)
                         $dataUl.append($subUlTwo)
                    }
                    
               }
               
          })
          

     </script>
</body>
</html>